# ТЗ v1.0 — RKN Clicker

## 1. Цель проекта
Сделать сатирический браузерный кликер про блокировки сервисов: игрок кликает, получает очки блокировки, покупает замедления и блокировки сервисов, ускоряет прогресс и доходит до финальной блокировки MAX.

## 2. Стек и платформа
- Платформа: веб-игра (desktop/mobile browser).
- Стек: React + TypeScript + Vite.
- Хранение прогресса: localStorage.
- Целевая интеграция: Яндекс Игры SDK (инициализация и ready в MVP-архитектуре, реклама позже).

## 3. Core-loop
1. Игрок нажимает главную кнопку и получает очки блокировки.
2. Тратит очки на сервисы: Замедлить или Заблокировать.
3. Замедления увеличивают базовый пассивный доход.
4. Блокировки дают множители дохода.
5. Растет шкала Народного недовольства.
6. На 100% открывается финальная цель (MAX).
7. Блокировка MAX завершает игру.

## 4. Основные ресурсы и формулы
- Валюта: Очки блокировки.
- Базовые параметры:
  - clickPower
  - basePassiveIncome
  - blockMultiplier
  - eventMultipliers

### Формулы
- `passiveIncomePerSec = basePassiveIncome * blockMultiplier * eventPassiveMultiplier`
- `clickIncome = clickPower * blockMultiplier * eventClickMultiplier`
- Итоговый доход считается по deltaTime в игровом тике.

## 5. Сервисы и действия
Каждый сервис имеет:
- id
- name
- tier
- slowCost
- slowEffect (добавка к basePassiveIncome)
- banCost
- banMultiplier (вклад в blockMultiplier)
- state: none | slowed | banned

### Правила покупки
- Блокировку можно купить сразу, даже если замедления не было.
- Если куплена блокировка, замедление этого сервиса становится недоступным.
- Если куплено замедление, блокировка все равно доступна позже.
- Повторные покупки по сервису не допускаются после blocked-state.

## 6. Прогрессия и финал
- Планируемая сетка MVP: 20 сервисов, 5 тиров по 4 сервиса.
- Этапы пока визуальные (без отдельных режимов).
- Шкала Народного недовольства:
  - 0–100%.
  - Заполняется только по количеству заблокированных сервисов.
  - При 100% открывается сервис MAX.
- Конец игры: блокировка MAX.

## 7. Случайные события (MVP)
- События есть, но механика простая.
- После каждой покупки (замедление/блокировка) планируется событие в окне 20–60 секунд.
- Одновременно активно не более одного события.
- Конкретный каталог событий будет определен в следующей версии ТЗ.
- На текущем этапе фиксируем только интерфейс событий.

## 8. UI v1 (обязательный минимум)

### TopBar
- Очки блокировки.
- Доход в секунду.
- Общий множитель блокировок.
- Прогресс-бар Народного недовольства.

### MainActionPanel
- Главная кнопка Блокировать.
- Визуальный +N при клике.
- Краткий индикатор активного события.

### ServicesPanel
- Карточки сервисов по тирам.
- Для карточки: название, статус, цена/эффект замедления, цена/эффект блокировки.
- Состояния кнопок: доступно / не хватает очков / уже куплено / недоступно по правилу.

### EventBanner
- Отображает текущее событие и таймер действия.

### BottomBar / Menu
- Сохранить.
- Сброс прогресса.
- Настройки (минимум: звук on/off, подтверждение сброса).
- Лог последних действий (5–10 записей).

### End Screen
- Появляется после блокировки MAX.
- Содержит итоговую статистику и кнопку новой игры (reset).

## 9. Сохранение и формат чисел
- Автосейв: каждые 10 секунд.
- Дополнительный сейв: после каждой покупки и при закрытии страницы.
- Формат больших чисел: K, M, B, T и далее.

## 10. Интеграция Яндекс Игр (минимум для архитектуры)
В MVP нужно:
- предусмотреть модуль-обертку SDK,
- инициализацию SDK,
- вызов ready после загрузки игры,
- заглушки для будущих рекламных вызовов.

## 11. Нефункциональные требования
- Игра должна работать в актуальных версиях Chrome/Firefox.
- UI должен быть адаптивным для мобильных экранов.
- Логика отделена от UI (game state/engine отдельно от React-компонентов).

### 11.1 Производительность
- Целевой FPS на основном экране:
  - desktop: не ниже 55 FPS на типовом устройстве (Core i5 / аналог, встроенная графика);
  - mobile: не ниже 45 FPS на типовом устройстве среднего уровня.
- Время обработки одного игрового тика (`update`): в среднем не более 4 мс, пиково не более 12 мс.
- Время реакции UI на клик по главной кнопке: визуальный отклик не более 100 мс.

### 11.2 Стабильность и корректность состояния
- При сворачивании вкладки и возврате игра корректно учитывает прошедшее время через `deltaTime` без скачков и ухода в `NaN/Infinity`.
- Все вычисляемые значения экономики должны оставаться конечными числами (`Number.isFinite === true`).
- Ошибки загрузки сохранения не должны приводить к падению приложения (см. кейс 13.3).

### 11.3 Сохранение прогресса
- Автосейв срабатывает каждые 10 секунд (допустимое отклонение: ±2 секунды при активной вкладке).
- Сейв выполняется после каждой успешной покупки и при событии закрытия страницы (`beforeunload/pagehide`).
- Размер JSON-сохранения в `localStorage` для MVP: не более 100 KB.
- Время сериализации и записи сохранения: не более 50 мс в типовом кейсе.

### 11.4 Адаптивность и поддержка экранов
- Поддерживаемая ширина viewport: от 320 px до 1920 px без потери критичных элементов управления.
- На экранах 320-480 px:
  - главная кнопка и баланс всегда видимы без горизонтального скролла;
  - карточки сервисов читаемы и имеют кликабельные зоны не менее 40x40 px.
- Поддерживаемые ориентации на mobile: portrait (обязательно), landscape (допустима упрощенная компоновка).

### 11.5 Архитектура и сопровождаемость
- Игровая логика (расчет дохода, покупок, состояний, событий) размещается вне React-компонентов в отдельном модуле `engine/state`.
- UI-компоненты не содержат бизнес-формул экономики, а получают готовые значения из state-слоя.
- Формат сохранения версионируется (`saveVersion`) с возможностью миграции в следующих версиях.

## 12. Что остается на ТЗ v1.1
- Точная баланс-таблица всех сервисов (цены, эффекты, множители).
- Точный каталог событий (типы, длительность, сила, шанс).
- Детальные настройки UI/темы/анимаций.
- Полная интеграция рекламы и пауз через Яндекс SDK.

## 13. Граничные и проблемные кейсы (MVP)

### Кейc 1. Недостаточно очков для покупки
- Условие: у игрока меньше очков, чем `slowCost` или `banCost`.
- Действие: игрок нажимает кнопку покупки.
- Ожидаемый результат:
  - покупка не выполняется;
  - баланс очков не меняется;
  - соответствующая кнопка недоступна (`disabled`);
  - в UI показывается причина недоступности (`Недостаточно очков`).

### Кейc 2. Конфликт состояний `slow`/`ban` по одному сервису
- Условие: сервис уже находится в состоянии `banned`.
- Действие: игрок пытается купить `slow`.
- Ожидаемый результат:
  - действие `slow` недоступно для этого сервиса;
  - повторные траты по сервису невозможны;
  - состояние сервиса не меняется (`banned`).

- Условие: сервис находится в состоянии `slowed`, у игрока хватает очков на `ban`.
- Действие: игрок покупает `ban`.
- Ожидаемый результат:
  - покупка `ban` выполняется успешно;
  - состояние сервиса меняется на `banned`;
  - повторная покупка `ban` недоступна.

### Кейc 3. Битое или устаревшее сохранение
- Условие: в `localStorage` сохранены неполные данные, неверные типы, отрицательные значения или неизвестная `version`.
- Действие: игра запускается и пытается загрузить сохранение.
- Ожидаемый результат:
  - приложение не падает;
  - данные проходят валидацию и нормализацию до безопасных значений по умолчанию;
  - некорректные поля игнорируются;
  - при критической несовместимости выполняется мягкий `reset` прогресса с уведомлением игрока.

## 14. Критерии готовности MVP (Definition of Done)

### 14.1 Core-loop и экономика
- Новый игрок может пройти путь от первого клика до блокировки `MAX` без тупиков и перезапуска.
- Формулы дохода из раздела 4 применяются в рантайме корректно (клик, пассив, множители событий).
- Покупки `slow/ban` соблюдают правила из раздела 5 и кейсы из раздела 13.
- Прогресс-бар Народного недовольства заполняется только от числа `banned`-сервисов и на 100% открывает `MAX`.

### 14.2 UI и UX минимум
- Все обязательные блоки из раздела 8 реализованы и доступны с keyboard/mouse/touch.
- Состояния кнопок сервисов отображаются корректно: `доступно / не хватает очков / уже куплено / недоступно по правилу`.
- Визуальный отклик на клик и обновление ключевых метрик (баланс, income/sec, множитель) происходят без заметной задержки.
- После блокировки `MAX` показывается `End Screen` с итоговой статистикой и рабочей кнопкой новой игры.

### 14.3 Сохранение и восстановление
- Автосейв, сейв после покупки и сейв при закрытии страницы работают по разделу 9 и 11.3.
- После перезагрузки страницы восстанавливаются: баланс, состояние сервисов, прогресс недовольства, активные постоянные множители.
- Битое/устаревшее сохранение обрабатывается без падения по правилам раздела 13 (кейс 3).

### 14.4 Интеграция Яндекс SDK
- В проекте есть отдельный модуль-обертка SDK.
- На старте игры выполняется инициализация SDK и вызов `ready`.
- Заглушки рекламных вызовов присутствуют в архитектуре и не ломают игровой цикл.

### 14.5 Техническое качество
- Нефункциональные требования раздела 11 выполняются в целевых браузерах.
- Нет блокирующих багов уровня `critical/high`, мешающих завершить сессию.
- Код разделяет логику `engine/state` и React UI, без дублирования бизнес-формул в компонентах.

### 14.6 Минимальный набор проверок перед приемкой
- Smoke-тест новой сессии: старт, 3-5 покупок, событие, прогресс, финал `MAX`.
- Smoke-тест сейва: автосейв -> перезагрузка -> корректное восстановление.
- Smoke-тест ограничений: попытка покупки без очков, попытка повторной покупки, обработка битого сейва.

## 15. Приоритизация объема (MVP vs v1.1)

### 15.1 MVP обязательное (Scope Lock)
- Разделы `1-6` целиком: цель, стек, core-loop, формулы, сервисы, прогрессия и финал `MAX`.
- Раздел `7`: базовый каркас событий (1 активное событие, окно 20-60 секунд, отображение в UI) без расширенного каталога.
- Раздел `8`: обязательные UI-блоки `TopBar`, `MainActionPanel`, `ServicesPanel`, `EventBanner`, `BottomBar/Menu`, `End Screen`.
- Раздел `9` целиком: автосейв, сейв по действиям, формат чисел.
- Раздел `10`: только архитектурный минимум SDK (`init + ready + заглушки`).
- Разделы `11`, `13`, `14` целиком: нефункциональные требования, проблемные кейсы, DoD.

### 15.2 v1.1 (после MVP)
- Полная баланс-таблица экономики (точные цены/эффекты/множители для всех сервисов).
- Расширенный каталог событий (типы, длительность, сила, шанс, правила конфликтов).
- Детальная визуальная полировка (тема, анимации, дополнительные UI-эффекты).
- Полноценная интеграция рекламы и пауз через Яндекс SDK.

### 15.3 Правило принятия задач в MVP
- Любая новая задача берется в MVP только если она:
  - влияет на проходимость core-loop до `MAX`;
  - закрывает критерий из раздела `14`;
  - или исправляет баг уровня `critical/high`.
- Все остальное автоматически маркируется как `v1.1` и не блокирует релиз MVP.

## 16. Архитектурное правило проекта

### 16.1 Выбранный подход
- Используется гибридный подход:
  - `FSD` для UI-части приложения;
  - отдельный модуль `engine` для игровой доменной логики.

### 16.2 Обязательные границы слоев
- `engine`:
  - чистая бизнес-логика игры (формулы, тик, покупки, прогресс, состояния сервисов, события);
  - без зависимостей от React, DOM и SDK.
- `app/state`:
  - orchestration-слой (store, вызовы use-case из `engine`, запуск тика, синхронизация с infra).
- `infra`:
  - адаптеры внешней среды (`localStorage`, обертка Яндекс SDK, таймеры, системные события страницы).
- `ui` (FSD-слои `pages/widgets/features/entities/shared`):
  - отображение состояния и отправка действий;
  - без бизнес-формул и мутаций игровой логики внутри компонентов.

### 16.3 Непереходные правила
- Все формулы экономики и правила покупки находятся только в `engine`.
- Тип сохранения (`SaveData`) отделен от runtime-состояния игры (`GameState`).
- Любая логика, влияющая на баланс/доход/переходы состояний, покрывается unit-тестами `engine`.
